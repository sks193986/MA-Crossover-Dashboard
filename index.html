<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Investment Portfolio Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; line-height: 1.6; min-height: 100vh; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header */
        .dashboard-header { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .dashboard-header h1 { font-size: 2.2em; color: #2c3e50; margin-bottom: 15px; text-align: center; }
        .header-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .portfolio-summary { display: flex; gap: 25px; flex-wrap: wrap; }
        .summary-item { display: flex; flex-direction: column; align-items: center; padding: 15px 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #6c757d; }
        .summary-item.success { border-left-color: #28a745; }
        .summary-item.error { border-left-color: #dc3545; }
        .summary-number { font-size: 1.8em; font-weight: bold; color: #2c3e50; }
        .summary-label { font-size: 0.9em; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Status Panel */
        .status-panel { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .status-info { display: flex; flex-direction: column; gap: 8px; }
        .status-item { display: flex; align-items: center; gap: 10px; }
        .status-icon { font-size: 1.2em; }
        .status-text { color: #495057; font-weight: 500; }

        /* API Status */
        .api-status { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .api-sources { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .api-source { padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center; }
        .api-source.primary { border-left: 4px solid #007bff; }
        .api-source.secondary { border-left: 4px solid #28a745; }
        .api-source.unlimited { border-left: 4px solid #17a2b8; }

        /* Buttons */
        .btn-main { background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.95em; cursor: pointer; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-1px); }
        .settings-btn { background: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .settings-btn:hover { background: #138496; }

        /* Portfolio Section */
        .portfolio-section { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .section-header h2 { color: #2c3e50; font-size: 1.6em; }
        .portfolio-controls { display: flex; gap: 10px; }
        .portfolio-table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .portfolio-table { width: 100%; border-collapse: collapse; background: white; }
        .portfolio-table th, .portfolio-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .portfolio-table th { background: #f8f9fa; font-weight: 600; color: #495057; position: sticky; top: 0; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #e9ecef; }
        .portfolio-table tr:hover { background: #f8f9fa; }
        .position-above { color: #28a745; font-weight: 600; }
        .position-below { color: #dc3545; font-weight: 600; }
        .position-unknown { color: #6c757d; }
        .data-source { font-size: 0.8em; opacity: 0.7; }

        /* Messages */
        .message { padding: 15px 20px; margin: 15px 0; border-radius: 10px; font-weight: 500; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

        /* Spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .api-sources { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>üìä My Investment Portfolio Dashboard</h1>
            <div class="header-info">
                <div class="portfolio-summary">
                    <div class="summary-item">
                        <span class="summary-number" id="total-investments">16</span>
                        <span class="summary-label">Investments</span>
                    </div>
                    <div class="summary-item success">
                        <span class="summary-number" id="above-ma">0</span>
                        <span class="summary-label">Above MA</span>
                    </div>
                    <div class="summary-item error">  
                        <span class="summary-number" id="below-ma">0</span>
                        <span class="summary-label">Below MA</span>
                    </div>
                </div>
                <button class="settings-btn" onclick="exportData()">üìä Export</button>
            </div>
        </header>

        <!-- API Status Panel -->
        <div class="api-status">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">üîó Multi-Source Data System</h3>
            <div class="api-sources">
                <div class="api-source primary">
                    <div style="font-weight: 600; margin-bottom: 5px;">ü•á Alpha Vantage</div>
                    <div style="font-size: 0.9em;">Primary source</div>
                    <div style="font-size: 0.8em; color: #666;">1000 calls/day</div>
                </div>
                <div class="api-source unlimited">
                    <div style="font-weight: 600; margin-bottom: 5px;">üöÄ Yahoo Finance</div>
                    <div style="font-size: 0.9em;">Unlimited backup</div>
                    <div style="font-size: 0.8em; color: #666;">No limits</div>
                </div>
                <div class="api-source secondary">
                    <div style="font-weight: 600; margin-bottom: 5px;">üìä Status</div>
                    <div style="font-size: 0.9em;" id="system-status">Ready</div>
                    <div style="font-size: 0.8em; color: #666;" id="calls-used">0 calls used</div>
                </div>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <div class="status-info">
                <div class="status-item">
                    <span class="status-icon">üéØ</span>
                    <span class="status-text">Multi-source system - Alpha Vantage primary, Yahoo Finance unlimited backup</span>
                </div>
                <div class="status-item">
                    <span class="status-icon">‚ö°</span>
                    <span class="status-text">10 second delays between calls to optimize performance</span>
                </div>
            </div>
            <button class="btn-main" onclick="checkAllInvestments()" id="check-btn">üîÑ Check All My Investments</button>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Portfolio Section -->
        <section class="portfolio-section">
            <div class="section-header">
                <h2>üìà My Investment Portfolio</h2>
                <div class="portfolio-controls">
                    <button onclick="refreshDisplay()" class="btn-secondary">üîÑ Refresh Display</button>
                </div>
            </div>

            <div class="portfolio-table-container">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('symbol')" class="sortable"># Symbol ‚ÜïÔ∏è</th>
                            <th onclick="sortTable('name')" class="sortable">Investment Name ‚ÜïÔ∏è</th>
                            <th onclick="sortTable('type')" class="sortable">Type ‚ÜïÔ∏è</th>
                            <th onclick="sortTable('currentPrice')" class="sortable">Current Price ‚ÜïÔ∏è</th>
                            <th onclick="sortTable('ma50')" class="sortable">50-day MA ‚ÜïÔ∏è</th>
                            <th>Position vs MA</th>
                            <th>Distance from MA</th>
                            <th>Data Source</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-tbody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; opacity: 0.7;">
                                <div style="font-size: 1.1em; margin-bottom: 10px;">üöÄ Multi-Source System Ready!</div>
                                <div>Click "Check All My Investments" to start monitoring with unlimited data access</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // DUAL API KEYS + YAHOO FINANCE BACKUP
        const API_KEYS = ['KKV2RG3N00OPLLW1', 'MX0AX5U6LX0HYGVW'];
        let currentKeyIndex = 0;
        let apiCallsUsed = 0;

        const investments = [
            { symbol: 'VOO', name: 'Vanguard S&P 500 ETF', type: 'Large Cap ETF' },
            { symbol: 'VEA', name: 'Vanguard Developed Markets ETF', type: 'International ETF' },
            { symbol: 'VTI', name: 'Vanguard Total Stock Market ETF', type: 'Broad Market ETF' },
            { symbol: 'EWJ', name: 'iShares MSCI Japan ETF', type: 'Country ETF' },
            { symbol: 'VWO', name: 'Vanguard Emerging Markets ETF', type: 'Emerging Markets ETF' },
            { symbol: 'EEM', name: 'iShares MSCI Emerging Markets ETF', type: 'Emerging Markets ETF' },
            { symbol: 'EWZ', name: 'iShares MSCI Brazil ETF', type: 'Country ETF' },
            { symbol: 'MCHI', name: 'iShares MSCI China ETF', type: 'Country ETF' },
            { symbol: 'BTC-USD', name: 'Bitcoin', type: 'Cryptocurrency' },
            { symbol: 'ETH-USD', name: 'Ethereum', type: 'Cryptocurrency' },
            { symbol: 'SOL-USD', name: 'Solana', type: 'Cryptocurrency' },
            { symbol: 'XRP-USD', name: 'Ripple', type: 'Cryptocurrency' },
            { symbol: 'SLV', name: 'iShares Silver Trust ETF', type: 'Precious Metals ETF' },
            { symbol: 'GLD', name: 'SPDR Gold Trust ETF', type: 'Precious Metals ETF' },
            { symbol: 'GBPUSD=X', name: 'British Pound/USD', type: 'Forex Pair' },
            { symbol: 'USDINR=X', name: 'US Dollar/Indian Rupee', type: 'Forex Pair' }
        ];

        let portfolioData = investments.map(inv => ({
            ...inv,
            currentPrice: 0,
            ma50: 0,
            position: 'unknown',
            distance: 0,
            dataSource: 'Not checked'
        }));

        let isChecking = false;

        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 8000);
        }

        function updateSystemStatus() {
            document.getElementById('calls-used').textContent = `${apiCallsUsed} calls used`;
            if (apiCallsUsed > 0) {
                document.getElementById('system-status').textContent = 'Active';
            }
        }

        function renderPortfolio() {
            const tbody = document.getElementById('portfolio-tbody');

            tbody.innerHTML = portfolioData.map((investment, index) => {
                const price = investment.currentPrice || 0;
                const ma50 = investment.ma50 || 0;
                const position = investment.position || 'unknown';
                const distance = investment.distance || 0;
                const dataSource = investment.dataSource || 'Not checked';

                let positionClass = 'position-unknown';
                let positionText = '‚ö™ Not checked';
                if (position === 'above') {
                    positionClass = 'position-above';
                    positionText = 'üü¢ Above MA';
                } else if (position === 'below') {
                    positionClass = 'position-below';
                    positionText = 'üî¥ Below MA';
                }

                let typeEmoji = '';
                if (investment.type.includes('ETF')) typeEmoji = 'üè¢';
                else if (investment.type.includes('Crypto')) typeEmoji = '‚Çø';
                else if (investment.type.includes('Forex')) typeEmoji = 'üí±';

                return `
                    <tr>
                        <td><strong>${index + 1}. ${investment.symbol.replace('=X', '').replace('-USD', '')}</strong></td>
                        <td>${typeEmoji} ${investment.name}</td>
                        <td>${investment.type}</td>
                        <td>${price > 0 ? '$' + price.toFixed(2) : 'Not checked'}</td>
                        <td>${ma50 > 0 ? '$' + ma50.toFixed(2) : 'Not checked'}</td>
                        <td><span class="${positionClass}">${positionText}</span></td>
                        <td>${distance !== 0 ? (distance > 0 ? '+' : '') + distance.toFixed(2) + '%' : '0.00%'}</td>
                        <td><span class="data-source">${dataSource}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            const total = portfolioData.length;
            const aboveMA = portfolioData.filter(inv => inv.position === 'above').length;
            const belowMA = portfolioData.filter(inv => inv.position === 'below').length;

            document.getElementById('total-investments').textContent = total;
            document.getElementById('above-ma').textContent = aboveMA;
            document.getElementById('below-ma').textContent = belowMA;

            updateSystemStatus();
        }

        function processPrices(investment, closes, source) {
            if (!closes || closes.length < 50) {
                throw new Error('Insufficient price data');
            }

            const validCloses = closes.filter(p => p !== null && p !== undefined && !isNaN(p));
            if (validCloses.length < 50) {
                throw new Error('Not enough valid price data');
            }

            const recentCloses = validCloses.slice(-50);
            const currentPrice = recentCloses[recentCloses.length - 1];
            const ma50 = recentCloses.reduce((sum, price) => sum + price, 0) / recentCloses.length;
            const position = currentPrice > ma50 ? 'above' : 'below';
            const distance = ((currentPrice - ma50) / ma50) * 100;

            return {
                success: true,
                currentPrice,
                ma50,
                position,
                distance,
                dataSource: source
            };
        }

        async function fetchFromAlphaVantage(symbol, type) {
            try {
                const currentKey = API_KEYS[currentKeyIndex];
                let url, functionType;

                if (type.includes('Crypto')) {
                    const cryptoSymbol = symbol.replace('-USD', '');
                    functionType = 'DIGITAL_CURRENCY_DAILY';
                    url = `https://www.alphavantage.co/query?function=${functionType}&symbol=${cryptoSymbol}&market=USD&apikey=${currentKey}`;
                } else if (type.includes('Forex')) {
                    const cleanSymbol = symbol.replace('=X', '');
                    const fromCurrency = cleanSymbol.substring(0, 3);
                    const toCurrency = cleanSymbol.substring(3);
                    functionType = 'FX_DAILY';
                    url = `https://www.alphavantage.co/query?function=${functionType}&from_symbol=${fromCurrency}&to_symbol=${toCurrency}&apikey=${currentKey}`;
                } else {
                    functionType = 'TIME_SERIES_DAILY';
                    url = `https://www.alphavantage.co/query?function=${functionType}&symbol=${symbol}&apikey=${currentKey}`;
                }

                console.log(`üîÑ Trying Alpha Vantage for ${symbol}...`);
                const response = await fetch(url);
                const data = await response.json();

                apiCallsUsed++;
                updateSystemStatus();

                if (data['Information'] && data['Information'].includes('rate limits')) {
                    currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
                    throw new Error('Rate limit reached');
                }

                if (data['Error Message'] || data['Note']) {
                    throw new Error(data['Error Message'] || 'API error');
                }

                let timeSeries;
                if (functionType === 'DIGITAL_CURRENCY_DAILY') {
                    timeSeries = data['Time Series (Digital Currency Daily)'];
                } else if (functionType === 'FX_DAILY') {
                    timeSeries = data['Time Series FX (Daily)'];
                } else {
                    timeSeries = data['Time Series (Daily)'];
                }

                if (!timeSeries) {
                    throw new Error('No time series data');
                }

                const dates = Object.keys(timeSeries).sort().reverse();
                const closes = dates.slice(0, 60).map(date => {
                    const dayData = timeSeries[date];
                    if (functionType === 'DIGITAL_CURRENCY_DAILY') {
                        return parseFloat(dayData['4a. close (USD)']);
                    } else {
                        return parseFloat(dayData['4. close']);
                    }
                });

                console.log(`‚úÖ Alpha Vantage success for ${symbol}`);
                return closes;

            } catch (error) {
                console.log(`‚ùå Alpha Vantage failed for ${symbol}: ${error.message}`);
                throw error;
            }
        }

        async function fetchFromYahoo(symbol) {
            try {
                console.log(`üîÑ Trying Yahoo Finance for ${symbol}...`);
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=60d`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                    throw new Error('No chart data');
                }

                const result = data.chart.result[0];
                const closes = result.indicators.quote[0].close;

                if (!closes || closes.length < 50) {
                    throw new Error('Insufficient data');
                }

                console.log(`‚úÖ Yahoo Finance success for ${symbol}`);
                return closes;

            } catch (error) {
                console.log(`‚ùå Yahoo Finance failed for ${symbol}: ${error.message}`);
                throw error;
            }
        }

        async function fetchInvestmentData(investment) {
            const symbol = investment.symbol;
            const type = investment.type;

            // Try Alpha Vantage first
            try {
                const closes = await fetchFromAlphaVantage(symbol, type);
                return processPrices(investment, closes, 'Alpha Vantage');
            } catch (avError) {
                console.log(`Alpha Vantage failed for ${symbol}, trying Yahoo Finance...`);

                // Fallback to Yahoo Finance
                try {
                    const closes = await fetchFromYahoo(symbol);
                    return processPrices(investment, closes, 'Yahoo Finance');
                } catch (yfError) {
                    console.error(`Both sources failed for ${symbol}`);
                    return {
                        success: false,
                        error: `Alpha Vantage: ${avError.message}, Yahoo: ${yfError.message}`,
                        dataSource: 'Failed'
                    };
                }
            }
        }

        async function checkAllInvestments() {
            if (isChecking) {
                showMessage('Portfolio check already in progress! Please wait...', 'warning');
                return;
            }

            isChecking = true;
            const btn = document.getElementById('check-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Starting portfolio check...';

            showMessage('üöÄ Starting multi-source portfolio check... Alpha Vantage primary, Yahoo Finance backup.', 'success');

            let successCount = 0;
            let errorCount = 0;
            let alphaVantageCount = 0;
            let yahooCount = 0;

            for (let i = 0; i < portfolioData.length; i++) {
                const investment = portfolioData[i];

                btn.innerHTML = `<span class="spinner"></span>Checking ${investment.symbol} (${i + 1}/${portfolioData.length})...`;

                const result = await fetchInvestmentData(investment);

                if (result.success) {
                    portfolioData[i] = {
                        ...investment,
                        currentPrice: result.currentPrice,
                        ma50: result.ma50,
                        position: result.position,
                        distance: result.distance,
                        dataSource: result.dataSource
                    };
                    successCount++;

                    if (result.dataSource === 'Alpha Vantage') alphaVantageCount++;
                    else if (result.dataSource === 'Yahoo Finance') yahooCount++;

                } else {
                    portfolioData[i].dataSource = 'Failed';
                    errorCount++;
                }

                renderPortfolio();
                updateStats();

                // 10 second delay between requests
                if (i < portfolioData.length - 1) {
                    for (let countdown = 10; countdown > 0; countdown--) {
                        btn.innerHTML = `<span class="spinner"></span>Next in ${countdown}s... (${i + 1}/${portfolioData.length} done, ${successCount} successful)`;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            btn.disabled = false;
            btn.innerHTML = 'üîÑ Check All My Investments';
            isChecking = false;

            let resultMessage = `‚úÖ Portfolio check complete! Successfully checked ${successCount}/${portfolioData.length} investments.`;
            if (alphaVantageCount > 0) resultMessage += ` Alpha Vantage: ${alphaVantageCount}.`;
            if (yahooCount > 0) resultMessage += ` Yahoo Finance: ${yahooCount}.`;
            if (errorCount > 0) resultMessage += ` Failed: ${errorCount}.`;

            showMessage(resultMessage, successCount > 0 ? 'success' : 'error');
        }

        function sortTable(key) {
            portfolioData.sort((a, b) => {
                let aVal = a[key] || 0;
                let bVal = b[key] || 0;

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                return aVal > bVal ? 1 : -1;
            });

            renderPortfolio();
        }

        function refreshDisplay() {
            renderPortfolio();
            updateStats();
            showMessage('üìä Display refreshed!', 'success');
        }

        function exportData() {
            try {
                const exportData = {
                    portfolio: portfolioData,
                    exportDate: new Date().toISOString(),
                    totalInvestments: portfolioData.length,
                    apiCallsUsed: apiCallsUsed,
                    dataSources: {
                        alphaVantage: portfolioData.filter(inv => inv.dataSource === 'Alpha Vantage').length,
                        yahooFinance: portfolioData.filter(inv => inv.dataSource === 'Yahoo Finance').length,
                        failed: portfolioData.filter(inv => inv.dataSource === 'Failed').length
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `multi-source-investments-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage('üìä Multi-source portfolio data exported successfully!', 'success');
            } catch (error) {
                showMessage('‚ùå Error exporting data', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            renderPortfolio();
            updateStats();
            showMessage('üöÄ Multi-source system loaded! Alpha Vantage primary + Yahoo Finance unlimited backup.', 'success');

            console.log('üìä Multi-Source Investment Portfolio Dashboard Loaded!');
            console.log('ü•á Primary: Alpha Vantage (1000 calls/day)');
            console.log('üöÄ Backup: Yahoo Finance (unlimited)');
            console.log('üìà Ready to monitor 16 investments with unlimited reliability');
        });
    </script>
</body>
</html>
